app-id: org.gajim.Gajim
runtime: org.gnome.Platform
runtime-version: '3.38'
sdk: org.gnome.Sdk
command: gajim
finish-args:
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --system-talk-name=org.freedesktop.GeoClue2
  - --system-talk-name=org.freedesktop.login1
  - --talk-name=org.mpris.MediaPlayer2.*
  - --talk-name=org.freedesktop.portal.Fcitx
  # Automatic status
  - --talk-name=org.gnome.Mutter.IdleMonitor
  # Keyring
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.kwalletd5
  # GnuPG
  - --filesystem=~/.gnupg
  # camera access
  - --device=all
  # extensions
  - --env=PYTHONPATH=/app/plugins/site-packages
  - --env=GI_TYPELIB_PATH=/app/lib/girepository-1.0:/app/plugins/lib/girepository-1.0

add-extensions:
  org.gajim.Gajim.Plugin:
    directory: plugins
    merge-dirs: lib;site-packages
    add-ld-path: lib
    subdirectories: true
    no-autodownload: true
    autodelete: true

cleanup:
  - /include
  - /lib/debug
  - /lib/pkgconfig
  - /share/gtk-doc
  - /share/man
  - '*.a'
  - '*.la'

modules:
  - name: python3-pyparsing
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app pyparsing-2.4.7-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/8a/bb/488841f56197b13700afd5658fc279a2025a39e22449b7cf29864669b15d/pyparsing-2.4.7-py2.py3-none-any.whl
        sha256: ef9d7589ef3c200abe66653d3f1ab1033c3c419ae9b9bdb1240a85b024efc88b

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app packaging-20.4-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/46/19/c5ab91b1b05cfe63cccd5cfc971db9214c6dd6ced54e33c30d5af1d2bc43/packaging-20.4-py2.py3-none-any.whl
        sha256: 998416ba6962ae7fbd6596850b80e17859a5753ba17c32284f67bfff33784181

  - name: python3-pycparser
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app pycparser-2.20-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/ae/e7/d9c3a176ca4b02024debf82342dab36efadfc5776f9c8db077e8f6e71821/pycparser-2.20-py2.py3-none-any.whl
        sha256: 7582ad22678f0fcd81102833f60ef8d0e57288b6b5fb00323d101be910e35705

  - name: python3-cffi
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/f7/09/88bbe20b76ca76be052c366fe77aa5e3cd6e5f932766e5597fecdd95b2a8/cffi-1.14.2.tar.gz
        sha256: ae8f34d50af2c2154035984b8b5fc5d9ed63f32fe615646ab435b05b132ca91b

  - name: python3-asn1crypto
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app asn1crypto-1.4.0-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/b5/a8/56be92dcd4a5bf1998705a9b4028249fe7c9a035b955fe93b6a3e5b829f8/asn1crypto-1.4.0-py2.py3-none-any.whl
        sha256: 4bcdf33c861c7d40bdcd74d8e4dd7661aac320fcdf40b9a3f95b4ee12fde2fa8

  - name: python3-idna
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app idna-2.10-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/a2/38/928ddce2273eaa564f6f50de919327bf3a00f091b5baba8dfa9460f3a8a8/idna-2.10-py2.py3-none-any.whl
        sha256: b97d804b1e9b523befed77c48dacec60e6dcb0b5391d57af6a65a312a90648c0

  - name: python3-cryptography
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/12/be/c9cc7d7ab71dbcc9e4e517ead0cdd48e8c9a48d7b8bdddb738e90d08279a/cryptography-3.1.tar.gz
        sha256: 26409a473cc6278e4c90f782cd5968ebad04d3911ed1c402fc86908c17633e08

  - name: python3-pyopenssl
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app pyOpenSSL-19.1.0-py2.py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/9e/de/f8342b68fa9e981d348039954657bdf681b2ab93de27443be51865ffa310/pyOpenSSL-19.1.0-py2.py3-none-any.whl
        sha256: 621880965a720b8ece2f1b2f54ea2071966ab00e2970ad2ce11d596102063504

  - name: python3-dbus-python
    build-options:
      env:
        PYTHON_VERSION: '3'
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/62/7e/d4fb56a1695fa65da0c8d3071855fa5408447b913c58c01933c2f81a269a/dbus-python-1.2.16.tar.gz
        sha256: 11238f1d86c995d8aed2e22f04a1e3779f0d70e587caffeab4857f3c662ed5a4

  - name: python3-jeepney
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app jeepney-0.4.3-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/79/31/2e8d42727595faf224c6dbb748c32b192e212f25495fe841fb7ce8e168b8/jeepney-0.4.3-py3-none-any.whl
        sha256: d6c6b49683446d2407d2fe3acb7a368a77ff063f9182fe427da15d622adc24cf

  - name: python3-secretstorage
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app SecretStorage-3.1.2-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c3/50/8a02cad020e949e6d7105f5f4530d41e3febcaa5b73f8f2148aacb3aeba5/SecretStorage-3.1.2-py3-none-any.whl
        sha256: b5ec909dde94d4ae2fa26af7c089036997030f0cf0a5cb372b4cccabd81c143b

  - name: python3-zipp
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app zipp-3.1.0-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/b2/34/bfcb43cc0ba81f527bc4f40ef41ba2ff4080e047acb0586b56b3d017ace4/zipp-3.1.0-py3-none-any.whl
        sha256: aa36550ff0c0b7ef7fa639055d797116ee891440eac1a56f378e2d3179e0320b

  - name: python3-keyring
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app keyring-21.4.0-py3-none-any.whl
    cleanup:
      - /bin
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/e4/ed/7be20815f248b0d6aae406783c2bee392640924623c4e17b50ca90c7f74d/keyring-21.4.0-py3-none-any.whl
        sha256: 4e34ea2fdec90c1c43d6610b5a5fafa1b9097db1802948e90caf5763974b8f8d

  - name: python3-css-parser
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app css_parser-1.0.4-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/py3/c/css_parser/css_parser-1.0.4-py3-none-any.whl
        sha256: 49d6906416569e715b144df97ed81a94b6dc663fbcae6d1dbf4807e7fb8367ae

  - name: python3-precis_i18n
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app precis_i18n-1.0.2-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/13/f5/3a7485a32dd4422a2a78de744bea4a00126b6001416c677b99c1a6e50e28/precis_i18n-1.0.2-py3-none-any.whl
        sha256: c7d5a1f5667a6e7cb85db0a5a4ec8e1090eaeb6e189e8131a5ee238492d60445

  # GSound dependency
  - name: libcanberra
    sources:
      - type: archive
        url: http://0pointer.de/lennart/projects/libcanberra/libcanberra-0.30.tar.xz
        sha256: c2b671e67e0c288a69fc33dc1b6f1b534d07882c2aceed37004bf48c601afa72
    config-opts:
      - "--disable-alsa"
      - "--disable-null"
      - "--disable-oss"

  - name: gsound
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gsound/1.0/gsound-1.0.2.tar.xz
        sha256: bba8ff30eea815037e53bee727bbd5f0b6a2e74d452a7711b819a7c444e78e53

  - name: gspell
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gspell/1.8/gspell-1.8.4.tar.xz
        sha256: cf4d16a716e813449bd631405dc1001ea89537b8cdae2b8abfb3999212bd43b4

  - name: farstream
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/farstream/farstream.git
        tag: 0.2.9
        commit: 1e42278d11730f8409878e3b4904fdd47e360e6f
      - type: patch
        path: farstream-make-4.3.patch

  - name: python3-nbxmpp
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app nbxmpp-1.0.2-py3-none-any.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/13/55/cc897ca99d8f39cc5d5ee93be9cd9ff9c3ab23bfe426c82d617b71b07b74/nbxmpp-1.0.2-py3-none-any.whl
        sha256: fcd32fdb257a673655f95d4584119e4772fc2d799125312b384a7d99ab1ae05b

  - name: gajim
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app .
      - touch /app/share/run-as-flatpak
    sources:
      - type: git
        url: https://dev.gajim.org/gajim/gajim.git
        tag: gajim-1.2.2
        commit: 8079c2d68aa1c63c0e4d4275346d82383bdb5139
    post-install:
      - install -d /app/plugins
